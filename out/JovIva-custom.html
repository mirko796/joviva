<!doctype html>
<html lang="en-us">

<head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">

    <!--Set visual viewport size for mobile devices to the device size,
        witch results in a scale of 1 and a 1:1 mapping between CSS pixels
        and Qt device independent pixels. -->
    <meta name="viewport" content="width=device-width, height=device-height, user-scalable=0" />

    <title>JovIva</title>
    <style>
        /* Make the html body cover the entire (visual) viewport with no scroll bars. */
        html,
        body {
            padding: 0;
            margin: 0;
            overflow: hidden;
            height: 100%
        }

        #screen {
            width: 100%;
            height: 100%;
        }
    </style>
</head>

<body onload="init()">
    <figure style="overflow:visible;" id="qtspinner">
        <center style="margin-top:1.5em; line-height:150%">
            <img src="qtlogo.svg" width="320" height="200" style="display:block"></img>
            <strong>Qt for WebAssembly: JovIva</strong>
            <div id="qtstatus"></div>
            <noscript>JavaScript is disabled. Please enable JavaScript to use this application.</noscript>
        </center>
    </figure>
    <button onclick="sendToQt()">Send to Qt</button>
    <div id="screen">
    </div>

    <script type='text/javascript'>
        let qtLoader = undefined;
        function init() {
            var spinner = document.querySelector('#qtspinner');
            var canvas = document.querySelector('#screen');
            var status = document.querySelector('#qtstatus')

            qtLoader = new QtLoader({
                canvasElements: [canvas],
                showLoader: function (loaderStatus) {
                    spinner.style.display = 'block';
                    canvas.style.display = 'none';
                    status.innerHTML = loaderStatus + "...";
                },
                showError: function (errorText) {
                    status.innerHTML = errorText;
                    spinner.style.display = 'block';
                    canvas.style.display = 'none';
                },
                showExit: function () {
                    status.innerHTML = "Application exit";
                    if (qtLoader.exitCode !== undefined)
                        status.innerHTML += " with code " + qtLoader.exitCode;
                    if (qtLoader.exitText !== undefined)
                        status.innerHTML += " (" + qtLoader.exitText + ")";
                    spinner.style.display = 'block';
                    canvas.style.display = 'none';
                },
                showCanvas: function () {
                    spinner.style.display = 'none';
                    canvas.style.display = 'block';
                },
            });
            qtLoader.loadEmscriptenModule("JovIva");
        }
    </script>
    <script type="text/javascript" src="qtloader.js"></script>
    <script type="text/javascript" src="qwebchannel.js"></script>

    <script>

        function sendToQt() {
            // Load the Emscripten module

            const Module = qtLoader.module();
            console.log(Module);
            // Create an instance of the C++ class
            // const myLibraryInstance = new Module.MyLibrary();

            // Call the C++ function from JavaScript
            Module.myFunction(1);
            Module.myFunctionChar("Hello from JavaScript");
            // Call the C++ function from JavaScript
            const pngBytesBase64 = Module.getByteArray();
            const pngBytes = Uint8Array.from(atob(pngBytesBase64), c => c.charCodeAt(0));
            console.log("Byte Array123:", pngBytes);
            // open png bytes as image in separate tab
            const blob = new Blob([pngBytes], { type: 'image/png' });
            const url = URL.createObjectURL(blob);
            window.open(url);
            //
        }
        function receiveFromQt() {
            console.log("Received from Qt");
            alert(5);
            sendToQt();
        }
    </script>
</body>

</html>